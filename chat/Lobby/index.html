<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scribblefight Lobby</title>
    <script defer src="http://localhost:3000/socket.io/socket.io.js"></script>
</head>
<body>       

    <script>
        let ws = new WebSocket("ws://localhost:9090")
        let clientId = null;
        let gameId = null;
        

       // ws.send(JSON.stringify(payLoad));
        ws.onmessage = message => {
            const response = JSON.parse(message.data);
            if(response.method === "connect"){
                clientId = response.clientId;
                console.log("Client id succesfully set" + clientId);
            }
            if(response.method === "create"){
                console.log("Game succesfully created with " + response.game.id);
                let gamecode = document.getElementById("gamecode");
                gameId = response.game.id;
                gamecode.innerHTML = "Gamecode: " +  gameId;
                const payLoad = {
                    "method": "join",
                    "clientId": clientId,
                    "gameId": gameId
                }

                ws.send(JSON.stringify(payLoad));
            }
            if (response.method === "join"){
                console.log(response.game.clients[response.game.clients.length-1])
                const game = response.game;
                localStorage.setItem("game",response.game)
                localStorage.setItem("player",response.clientId)
                var i = 0;
                const playerlist = document.getElementById('playerlist');
                playerlist.innerHTML = "";
                game.clients.forEach(c => {
                    playerlist.innerHTML += "User: " + game.clients[i].clientId + ", ";
                    i++;
                });
            }
            if(response.method === "newClient"){
                console.log(response.newClient)
                let localClient = response.newClient;
                let localGame = response.gameId;
                localStorage.setItem("localClient", localClient)
                localStorage.setItem("localGame", localGame)
            }
            if(response.method === "error"){
                console.log("Error: " + response.message)
            }
            console.log(response);
        }
    </script>
    <div id="lobby" style="visibility: visible;">
    <h1>Scribblefight Lobby</h1>
    <button id="btnCreate">Create</button>
    <button id="btnJoin">Join</button>
    <input type="text" id="txtGameId">
        </div>
        <p id="gamecode"></p>
    <!-- Chat Connected => Visibility visible -->
    <div id ="chat" style="visibility: hidden;">
        <div id="message-container"></div>
        <form id="send-container">
            <input type="text" id="message-input" placeholder="Chat...">
            <button type="submit" id="send-button">Send</button>
        </form>
        <div id="playerlist"></div>
        </div>

        <div id="QR" style="visibility: hidden;">
        <a href="http://localhost:9091/qrcode.html"><div id="qrcode"></div></a>
        </div>
        <script src="jquery.min.js"></script>
        <script type="text/javascript" src="qrcode.js"></script>
        <script type="text/javascript">
        new QRCode(document.getElementById("qrcode"), "http://localhost:9091/qrcode.html");
</script>
    <script>
        window.onload = function(){
            const playerlist = document.getElementById('playerlist');
            const lobby = document.getElementById('lobby');
            const QR = document.getElementById('QR');
            const chat = document.getElementById('chat');
            var players = [];
            //chat
            const socket = io('http://localhost:3000')
            const messageContainer = document.getElementById('message-container')
            const messageForm = document.getElementById("send-container")
            const messageInput = document.getElementById("message-input")
                        
            socket.on('chat-message', data => {
                appendMessage(`${data.name}: ${data.message}`)
            })

            socket.on('user-connected', name => {
                appendMessage(`${name} connected`)
            })

            socket.on('user-disconnected', name => {
                appendMessage(`${name} disconnected`)
            })

            messageForm.addEventListener('submit', e => {
                e.preventDefault()
                const message = messageInput.value
                appendMessage(`You: ${message}`)
                socket.emit('send-chat-message', message)
                messageInput.value = ''
            })

            const btnCreate = document.getElementById("btnCreate");
            const btnJoin = document.getElementById("btnJoin");
            const txtGameId = document.getElementById("txtGameId");
            btnCreate.addEventListener("click", e => {

                const payLoad = {
                    "method": "create",
                    "clientId": clientId
                }
                newUser(clientId)
                ws.send(JSON.stringify(payLoad));

            });
            btnJoin.addEventListener("click", e => {
                if(gameId === null)
                    gameId = txtGameId.value;
                const payLoad = {
                    "method": "join",
                    "clientId": clientId,
                    "gameId": gameId
                }

                newUser(clientId)

                ws.send(JSON.stringify(payLoad));
            })  
            function appendMessage(message) {
                const messageElement = document.createElement('div')
                messageElement.innerText = message

                messageContainer.append(messageElement)
            }
            function newUser(clientId){
            const name = prompt('What is your name?')
                players.push(name, clientId);
                console.log(players)
                appendMessage('You joined')
                socket.emit('new-user', name)
                lobby.style.visibility = "hidden";
                chat.style.visibility = "visible";
                QR.style.visibility = "visible";
            }
             
        }      
        
        
    </script>

    <script>
        
    </script>
</body>
</html>